services:
    # MySQL Database (Latest LTS)
    db:
        image: mysql:8.4-oracle
        container_name: linkmy_mysql
        restart: always
        command: --default-authentication-plugin=mysql_native_password --sql-mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION"
        environment:
            MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
            MYSQL_DATABASE: ${DB_NAME:-linkmy_db}
            MYSQL_USER: ${DB_USER:-linkmy_user}
            MYSQL_PASSWORD: ${DB_PASSWORD:-linkmy_password}
        volumes:
            - mysql_data:/var/lib/mysql
            - ./linkmy_db.sql:/docker-entrypoint-initdb.d/init.sql
        ports:
            - '3307:3306'
        networks:
            - linkmy_network
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            interval: 10s
            timeout: 5s
            retries: 5

    # PHP Apache Web Server
    web:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: linkmy_web
        restart: always
        depends_on:
            - db
        environment:
            # Database Config
            DB_HOST: db
            DB_USER: ${DB_USER:-linkmy_user}
            DB_PASSWORD: ${DB_PASSWORD:-linkmy_password}
            DB_NAME: ${DB_NAME:-linkmy_db}

            # Email Config (PHPMailer)
            MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
            MAIL_PORT: ${MAIL_PORT:-587}
            MAIL_USERNAME: ${MAIL_USERNAME}
            MAIL_PASSWORD: ${MAIL_PASSWORD}
            MAIL_FROM_EMAIL: ${MAIL_FROM_EMAIL:-noreply@linkmy.iet.ovh}
            MAIL_FROM_NAME: ${MAIL_FROM_NAME:-LinkMy}
        volumes:
            - ./:/var/www/html
            - ./uploads:/var/www/html/uploads
        ports:
            - '83:80'
            - '443:443'
        networks:
            - linkmy_network

    # phpMyAdmin (Latest Stable)
    phpmyadmin:
        image: phpmyadmin:5.2-apache
        container_name: linkmy_phpmyadmin
        restart: always
        depends_on:
            db:
                condition: service_healthy
        environment:
            PMA_HOST: db
            PMA_PORT: 3306
            MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
            UPLOAD_LIMIT: 300M
        ports:
            - '8083:80'
        networks:
            - linkmy_network

volumes:
    mysql_data:
        driver: local

networks:
    linkmy_network:
        driver: bridge
